<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Forgot Password - EduWings</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
body {
    background-color: #fff3f5;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.card { 
    width: 420px; 
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    border: none;
}
.card h4 {
    color: #6a11cb;
    font-weight: 600;
}
.btn-primary {
    background: linear-gradient(45deg, #6a11cb, #2575fc);
    border: none;
    border-radius: 8px;
    padding: 10px;
    font-weight: 500;
    transition: all 0.3s;
}
.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(106, 17, 203, 0.4);
}
.btn-success {
    background: linear-gradient(45deg, #11998e, #38ef7d);
    border: none;
    border-radius: 8px;
    padding: 10px;
    font-weight: 500;
    transition: all 0.3s;
}
.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
}
.form-control {
    border-radius: 8px;
    padding: 12px;
    border: 1px solid #ddd;
    transition: border-color 0.3s;
}
.form-control:focus {
    border-color: #6a11cb;
    box-shadow: 0 0 0 0.25rem rgba(106, 17, 203, 0.15);
}
.logo {
    text-align: center;
    margin-bottom: 20px;
    font-size: 28px;
    font-weight: bold;
    color: #6a11cb;
}
.step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
}
.step {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 10px;
    font-weight: bold;
    color: #6c757d;
}
.step.active {
    background-color: #6a11cb;
    color: white;
}
.step-line {
    width: 40px;
    height: 2px;
    background-color: #e9ecef;
    margin: 0 5px;
    align-self: center;
}
</style>
</head>
<body>

<div class="card p-4">
  <div class="logo">EduWings</div>
  
  <div class="step-indicator">
    <div class="step active">1</div>
    <div class="step-line"></div>
    <div class="step">2</div>
  </div>
  
  <h4 class="mb-3 text-center">Forgot Password</h4>

  <!-- Step 1: Request OTP -->
  <div id="step-request">
    <div class="mb-3">
      <label class="form-label">Email</label>
      <input id="fp-email" class="form-control" type="email" placeholder="you@example.com" required>
    </div>
    <button id="btn-request-otp" class="btn btn-primary w-100">Send OTP</button>
  </div>

  <!-- Step 2: Verify OTP & Reset -->
  <div id="step-reset" style="display:none;">
    <div class="mb-3">
      <label class="form-label">OTP</label>
      <input id="fp-otp" class="form-control" type="text" placeholder="6-digit OTP">
    </div>
    <div class="mb-3">
      <label class="form-label">New password</label>
      <input id="fp-password" class="form-control" type="password" placeholder="New password">
    </div>
    <div class="mb-3">
      <label class="form-label">Confirm password</label>
      <input id="fp-confirm" class="form-control" type="password" placeholder="Confirm password">
    </div>
    <div class="d-flex gap-2">
      <button id="btn-verify-reset" class="btn btn-success w-100">Verify & Reset</button>
      <button id="btn-back" class="btn btn-outline-secondary w-100">Back</button>
    </div>
  </div>
</div>

<script>
const API_BASE = "http://localhost:8080/auth"; // your backend URL

const stepRequest = document.getElementById('step-request');
const stepReset = document.getElementById('step-reset');
const steps = document.querySelectorAll('.step');

// Step 1: Send OTP
document.getElementById('btn-request-otp').addEventListener('click', async () => {
    const email = document.getElementById('fp-email').value.trim();
    if (!email) { 
        Swal.fire({
            icon: 'warning',
            title: 'Email Required',
            text: 'Please enter your email address'
        }); 
        return; 
    }
    
    // Simple email validation
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(email)) {
        Swal.fire({
            icon: 'warning',
            title: 'Invalid Email',
            text: 'Please enter a valid email address'
        });
        return;
    }

    try {
        // Show loading state
        Swal.fire({
            title: 'Sending OTP',
            text: 'Please wait...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        const res = await fetch(`${API_BASE}/forgot-password`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ email })
        });
        
        Swal.close();
        
        if (!res.ok) {
            const err = await res.text(); 
            throw new Error(err || 'Request failed');
        }
        
        Swal.fire({ 
            icon: 'success', 
            title: 'OTP Sent Successfully', 
            text: 'Check your email for the verification code' 
        });
        
        // Update step indicator
        steps[0].classList.remove('active');
        steps[1].classList.add('active');
        
        stepRequest.style.display = 'none';
        stepReset.style.display = 'block';
    } catch (err) {
        Swal.fire({ 
            icon: 'error', 
            title: 'Error', 
            text: err.message || 'Failed to send OTP' 
        });
    }
});

// Step 2: Verify OTP & Reset
document.getElementById('btn-verify-reset').addEventListener('click', async () => {
    const email = document.getElementById('fp-email').value.trim();
    const otp = document.getElementById('fp-otp').value.trim();
    const password = document.getElementById('fp-password').value;
    const confirm = document.getElementById('fp-confirm').value;

    if (!otp || !password || !confirm) { 
        Swal.fire({
            icon: 'warning',
            title: 'Missing Fields',
            text: 'Please fill all fields'
        }); 
        return; 
    }
    
    if (password.length < 6) {
        Swal.fire({
            icon: 'warning',
            title: 'Weak Password',
            text: 'Password should be at least 6 characters long'
        });
        return;
    }
    
    if (password !== confirm) { 
        Swal.fire({ 
            icon: 'warning', 
            title: 'Passwords do not match' 
        }); 
        return; 
    }

    try {
        // Show loading state
        Swal.fire({
            title: 'Resetting Password',
            text: 'Please wait...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // const res = await fetch(`${API_BASE}/reset-password`, {
        //     method: 'POST',
        //     headers: {'Content-Type':'application/json'},
        //     body: JSON.stringify({ email, otp, password })
        // });
        // In your resetPassword function:
const res = await fetch(`${API_BASE}/reset-password`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ 
        email: email, 
        otp: otp, 
        newPassword: password 
    })
});
        Swal.close();
        
        if (!res.ok) {
            const err = await res.text(); 
            throw new Error(err || 'Reset failed');
        }
        
        Swal.fire({ 
            icon: 'success', 
            title: 'Password Reset Successful', 
            text: 'You can now log in with your new password' 
        }).then(() => {
            window.location.href = '/login.html';
        });
    } catch (err) {
        Swal.fire({ 
            icon: 'error', 
            title: 'Error', 
            text: err.message || 'Failed to reset password' 
        });
    }
});

// Back button
document.getElementById('btn-back').addEventListener('click', () => {
    // Update step indicator
    steps[1].classList.remove('active');
    steps[0].classList.add('active');
    
    stepReset.style.display = 'none';
    stepRequest.style.display = 'block';
});
</script>

</body>
</html>